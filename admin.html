<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin | Appointments - Bengaluru City Hospital</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  />

  <style>
    * {
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }
    body {
      background: radial-gradient(circle at top, #1f2937, #020617);
      color: #e5e7eb;
      min-height: 100vh;
    }
    .card {
      border-radius: 1rem;
    }
    .badge-pill {
      border-radius: 999px;
    }
    .status-select {
      font-size: 0.75rem;
      padding: 0.15rem 0.25rem;
      border-radius: 999px;
    }
    .status-badge {
      border-radius: 999px;
      padding: 0.15rem 0.5rem;
      font-size: 0.75rem;
    }
    .bg-main {
      background: linear-gradient(135deg, #0f172a, #020617);
    }
  </style>
</head>
<body class="bg-main">
  <div class="container py-4">
    <header class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="mb-0">
          <i class="bi bi-hospital me-2"></i>
          Bengaluru City Hospital
        </h3>
        <small class="text-muted">Admin – Appointments Dashboard</small>
      </div>
      <div class="text-end">
        <span class="badge bg-info text-dark badge-pill mb-1">
          <i class="bi bi-geo-alt me-1"></i>
          Bengaluru Urban • 560078
        </span>
        <div id="adminUserInfo" class="small text-muted"></div>
      </div>
    </header>

    <!-- LOGIN VIEW -->
    <div id="loginView" class="row justify-content-center">
      <div class="col-md-5">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h5 class="card-title mb-2">
              <i class="bi bi-shield-lock me-1"></i>
              Admin Login
            </h5>
            <p class="small text-muted mb-3">
              Only authorised hospital staff should log in to view appointment details.
            </p>

            <div id="loginError" class="alert alert-danger py-2 px-3 d-none small">
              <i class="bi bi-exclamation-triangle me-1"></i>
              Invalid credentials or network error. Please try again.
            </div>

            <form id="loginForm">
              <div class="mb-3">
                <label class="form-label small">Email</label>
                <input
                  type="email"
                  id="loginEmail"
                  class="form-control form-control-sm"
                  placeholder="admin@example.com"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label small">Password</label>
                <input
                  type="password"
                  id="loginPassword"
                  class="form-control form-control-sm"
                  placeholder="••••••••"
                  required
                />
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-sm btn-primary">
                  <i class="bi bi-box-arrow-in-right me-1"></i>
                  Sign In
                </button>
              </div>
            </form>
            <p class="small text-muted mt-3 mb-0">
              Tip: Create admin users in Supabase &gt; Auth &gt; Users.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="dashboardView" class="d-none">
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label text-muted small">Service / Concern</label>
              <input
                type="text"
                id="filterService"
                class="form-control form-control-sm"
                placeholder="Search by service"
              />
            </div>
            <div class="col-md-3">
              <label class="form-label text-muted small">Preferred Date</label>
              <input
                type="date"
                id="filterDate"
                class="form-control form-control-sm"
              />
            </div>
            <div class="col-md-3">
              <label class="form-label text-muted small">Status</label>
              <select id="filterStatus" class="form-select form-select-sm">
                <option value="">All</option>
                <option value="Pending">Pending</option>
                <option value="Confirmed">Confirmed</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
            <div class="col-md-3 d-flex justify-content-md-end align-items-end">
              <button id="refreshBtn" class="btn btn-sm btn-outline-light me-2">
                <i class="bi bi-arrow-clockwise me-1"></i>
                Refresh
              </button>
              <button id="logoutBtn" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-box-arrow-right me-1"></i>
                Logout
              </button>
            </div>
          </div>
          <div class="mt-3 d-flex justify-content-between small text-muted">
            <span>
              Total appointments:
              <span id="totalCount" class="fw-semibold">0</span>
            </span>
            <span>
              <i class="bi bi-square-fill text-success me-1"></i>
              rows highlighted in green are for <strong>today</strong>.
            </span>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-dark table-hover table-striped mb-0 align-middle">
              <thead class="small">
                <tr>
                  <th>#</th>
                  <th>Patient Name</th>
                  <th>Phone</th>
                  <th>Service / Concern</th>
                  <th>Preferred Date</th>
                  <th>Status</th>
                  <th>Notes</th>
                  <th>Created At</th>
                </tr>
              </thead>
              <tbody id="appointmentsTableBody" class="small"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div
        id="adminError"
        class="alert alert-danger mt-3 py-2 px-3 d-none small"
      >
        <i class="bi bi-exclamation-triangle me-1"></i>
        Unable to load or update appointments. Check Supabase settings or network.
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // TODO: set these to your real project values
       const SUPABASE_URL = "https://tcdvowvadvszxhjsciaz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjZHZvd3ZhZHZzenhoanNjaWF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDI3MzksImV4cCI6MjA3ODk3ODczOX0.Qn5MmXPV2JXIm8BgsjkknIWv8Oi5PcWNgRXZlRwVDlc"; // or a service role key, if this is protected behind auth

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const loginView = document.getElementById("loginView");
    const dashboardView = document.getElementById("dashboardView");
    const loginForm = document.getElementById("loginForm");
    const loginError = document.getElementById("loginError");
    const adminError = document.getElementById("adminError");
    const adminUserInfo = document.getElementById("adminUserInfo");

    const filterService = document.getElementById("filterService");
    const filterDate = document.getElementById("filterDate");
    const filterStatus = document.getElementById("filterStatus");
    const refreshBtn = document.getElementById("refreshBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const tbody = document.getElementById("appointmentsTableBody");
    const totalCountEl = document.getElementById("totalCount");

    // ---- AUTH HANDLING ----
    async function checkSessionOnLoad() {
      const { data } = await supabaseClient.auth.getSession();
      if (data.session) {
        showDashboard(data.session.user);
      } else {
        showLogin();
      }
    }

    function showLogin() {
      loginView.classList.remove("d-none");
      dashboardView.classList.add("d-none");
      adminUserInfo.textContent = "";
    }

    function showDashboard(user) {
      loginView.classList.add("d-none");
      dashboardView.classList.remove("d-none");
      adminUserInfo.textContent = user
        ? `Signed in as ${user.email}`
        : "";
      loadAppointments();
    }

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.classList.add("d-none");

      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      const btn = loginForm.querySelector("button[type='submit']");
      const original = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML =
        '<span class="spinner-border spinner-border-sm me-1"></span>Signing in...';

      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password,
      });

      btn.disabled = false;
      btn.innerHTML = original;

      if (error || !data.session) {
        console.error("Login error:", error);
        loginError.classList.remove("d-none");
        return;
      }

      showDashboard(data.session.user);
    });

    logoutBtn.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      showLogin();
    });

    // ---- LOAD APPOINTMENTS ----
    async function loadAppointments() {
      adminError.classList.add("d-none");
      tbody.innerHTML = `
        <tr>
          <td colspan="8" class="text-center py-3">
            <div class="spinner-border spinner-border-sm me-2"></div>
            Loading appointments...
          </td>
        </tr>
      `;

      let query = supabaseClient
        .from("appointments")
        .select("*")
        .order("created_at", { ascending: false });

      const serviceFilter = filterService.value.trim();
      const dateFilter = filterDate.value;
      const statusFilter = filterStatus.value;

      if (serviceFilter) {
        query = query.ilike("service_type", "%" + serviceFilter + "%");
      }
      if (dateFilter) {
        query = query.eq("preferred_date", dateFilter);
      }
      if (statusFilter) {
        query = query.eq("status", statusFilter);
      }

      const { data, error } = await query;

      if (error) {
        console.error("Error loading appointments:", error);
        adminError.classList.remove("d-none");
        tbody.innerHTML = "";
        totalCountEl.textContent = "0";
        return;
      }

      if (!data || data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-3 text-muted">
              No appointments found for the selected filters.
            </td>
          </tr>
        `;
        totalCountEl.textContent = "0";
        return;
      }

      totalCountEl.textContent = data.length.toString();
      tbody.innerHTML = "";

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      const todayStr = `${yyyy}-${mm}-${dd}`;

      data.forEach((row, idx) => {
        const tr = document.createElement("tr");

        const isToday = row.preferred_date === todayStr;
        if (isToday) {
          tr.classList.add("table-success"); // highlight today's appointments
        }

        // Status badge colors
        let statusClass = "bg-secondary";
        if (row.status === "Pending") statusClass = "bg-warning text-dark";
        if (row.status === "Confirmed") statusClass = "bg-info text-dark";
        if (row.status === "Completed") statusClass = "bg-success";
        if (row.status === "Cancelled") statusClass = "bg-danger";

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${row.name || "-"}</td>
          <td>${row.phone || "-"}</td>
          <td>${row.service_type || "-"}</td>
          <td>${row.preferred_date || "-"}</td>
          <td>
            <select class="form-select form-select-sm status-select" data-id="${row.id}">
              <option value="Pending" ${row.status === "Pending" ? "selected" : ""}>Pending</option>
              <option value="Confirmed" ${row.status === "Confirmed" ? "selected" : ""}>Confirmed</option>
              <option value="Completed" ${row.status === "Completed" ? "selected" : ""}>Completed</option>
              <option value="Cancelled" ${row.status === "Cancelled" ? "selected" : ""}>Cancelled</option>
            </select>
          </td>
          <td>${row.notes ? row.notes.substring(0, 60) : "-"}</td>
          <td>${row.created_at ? new Date(row.created_at).toLocaleString() : "-"}</td>
        `;
        tbody.appendChild(tr);
      });

      // Attach change listeners for all status selects
      attachStatusChangeHandlers();
    }

    function attachStatusChangeHandlers() {
      const selects = tbody.querySelectorAll(".status-select");
      selects.forEach((select) => {
        select.addEventListener("change", async (e) => {
          const appointmentId = e.target.getAttribute("data-id");
          const newStatus = e.target.value;

          try {
            const { error } = await supabaseClient
              .from("appointments")
              .update({ status: newStatus })
              .eq("id", appointmentId);

            if (error) {
              console.error("Error updating status:", error);
              adminError.classList.remove("d-none");
            } else {
              adminError.classList.add("d-none");
            }
          } catch (err) {
            console.error("Unexpected error updating status:", err);
            adminError.classList.remove("d-none");
          }
        });
      });
    }

    // Filters / events
    refreshBtn.addEventListener("click", loadAppointments);
    filterService.addEventListener("input", () => loadAppointments());
    filterDate.addEventListener("change", () => loadAppointments());
    filterStatus.addEventListener("change", () => loadAppointments());

    // Initial check for session
    checkSessionOnLoad();
  </script>
</body>
</html>
